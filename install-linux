#!/bin/bash

# ==============================================================================
# CLIProxy Ultimate Installer for Linux
# Includes: Go, Git, CLIProxyAPIPlus, and Shortcuts
# ==============================================================================

# --- Colors ---
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# --- Helper Functions ---

# --- OS Detection ---
detect_distro() {
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        OS_NAME=$NAME
        DISTRO_ID=$ID
    else
        OS_NAME=$(uname -s)
        DISTRO_ID="unknown"
    fi
}

install_dependencies() {
    detect_distro
    echo -e "${YELLOW}Detected OS: $OS_NAME ($DISTRO_ID)${NC}"

    if command -v git &> /dev/null && command -v go &> /dev/null; then
        echo -e "${GREEN}[OK] Git and Go are already installed.${NC}"
        return 0
    fi

    echo -e "${YELLOW}Installing dependencies...${NC}"

    case $DISTRO_ID in
        ubuntu|debian|kali|pop)
            sudo apt-get update
            sudo apt-get install -y git golang
            ;;
        fedora|centos|rhel)
            sudo dnf install -y git golang || sudo yum install -y git golang
            ;;
        arch|manjaro)
            sudo pacman -Syu --noconfirm git go
            ;;
        opensuse*|suse)
            sudo zypper install -y git go
            ;;
        *)
            echo -e "${RED}[!] Unsupported distro for auto-install.${NC}"
            echo "Please manually install 'git' and 'go' using your package manager."
            if ! command -v go &> /dev/null; then exit 1; fi
            ;;
    esac

    echo -e "${GREEN}[OK] Dependencies ready.${NC}"
}

setup_shortcuts() {
    SHELL_CONFIG="$HOME/.bashrc"
    if [[ "$SHELL" == *"zsh"* ]]; then
        SHELL_CONFIG="$HOME/.zshrc"
    elif [[ "$SHELL" == *"fish"* ]]; then
        # Fish uses different syntax - create fish config
        FISH_CONFIG="$HOME/.config/fish/config.fish"
        mkdir -p "$(dirname "$FISH_CONFIG")"

        echo -e "${YELLOW}Adding shortcuts for Fish shell to $FISH_CONFIG...${NC}"

        # Remove old aliases
        sed -i '/alias cp-login/d' "$FISH_CONFIG" 2>/dev/null || true
        sed -i '/alias cp-start/d' "$FISH_CONFIG" 2>/dev/null || true
        sed -i '/alias cp-update/d' "$FISH_CONFIG" 2>/dev/null || true
        sed -i '/alias cp-logout/d' "$FISH_CONFIG" 2>/dev/null || true
        sed -i '/alias cp-uninstall/d' "$FISH_CONFIG" 2>/dev/null || true

        # Add new aliases (Fish syntax)
        echo "" >> "$FISH_CONFIG"
        echo "# CLIProxy Shortcuts" >> "$FISH_CONFIG"
        echo "alias cp-login='$HOME/.cli-proxy-api/scripts/login.sh'" >> "$FISH_CONFIG"
        echo "alias cp-start='$HOME/.cli-proxy-api/scripts/start.sh'" >> "$FISH_CONFIG"
        echo "alias cp-logout='$HOME/.cli-proxy-api/scripts/logout.sh'" >> "$FISH_CONFIG"
        echo "alias cp-uninstall='$HOME/.cli-proxy-api/scripts/uninstall.sh'" >> "$FISH_CONFIG"
        echo "alias cp-update='curl -sL https://raw.githubusercontent.com/khmuhtadin/cliproxy-installer/main/install-linux | bash -s -- -update'" >> "$FISH_CONFIG"

        echo -e "${GREEN}[OK] Fish shortcuts added!${NC}"
        return
    fi

    echo -e "${YELLOW}Adding shortcuts (cp-login, cp-start, cp-logout, cp-uninstall, cp-update) to $SHELL_CONFIG...${NC}"

    # Remove old aliases if they exist (Linux sed syntax: no empty string after -i)
    sed -i '/alias cp-login/d' "$SHELL_CONFIG" 2>/dev/null || true
    sed -i '/alias cp-start/d' "$SHELL_CONFIG" 2>/dev/null || true
    sed -i '/alias cp-update/d' "$SHELL_CONFIG" 2>/dev/null || true
    sed -i '/alias cp-logout/d' "$SHELL_CONFIG" 2>/dev/null || true
    sed -i '/alias cp-uninstall/d' "$SHELL_CONFIG" 2>/dev/null || true

    # Add new aliases
    echo "" >> "$SHELL_CONFIG"
    echo "# CLIProxy Shortcuts" >> "$SHELL_CONFIG"
    echo "alias cp-login=\"$HOME/.cli-proxy-api/scripts/login.sh\"" >> "$SHELL_CONFIG"
    echo "alias cp-start=\"$HOME/.cli-proxy-api/scripts/start.sh\"" >> "$SHELL_CONFIG"
    echo "alias cp-logout=\"$HOME/.cli-proxy-api/scripts/logout.sh\"" >> "$SHELL_CONFIG"
    echo "alias cp-uninstall=\"$HOME/.cli-proxy-api/scripts/uninstall.sh\"" >> "$SHELL_CONFIG"
    echo "alias cp-update=\"curl -sL https://raw.githubusercontent.com/khmuhtadin/cliproxy-installer/main/install-linux | bash -s -- -update\"" >> "$SHELL_CONFIG"

    echo -e "${GREEN}[OK] Shortcuts added!${NC}"
}

install_cliproxy() {
    if ! command -v go &> /dev/null; then
        echo -e "${RED}[Error] Go is not found!${NC}"
        echo "Please run option 1 to install dependencies first."
        exit 1
    fi

    echo -e "${YELLOW}>>> Starting CLIProxy Installation...${NC}"

    BIN_DIR="$HOME/bin"
    CONFIG_DIR="$HOME/.cli-proxy-api"
    SCRIPTS_DIR="$CONFIG_DIR/scripts"

    # Ensure bin is in PATH
    if [[ ":$PATH:" != ":$HOME/bin:"* ]]; then
        echo 'export PATH="$HOME/bin:$PATH"' >> "$HOME/.bashrc"
        [ -f "$HOME/.zshrc" ] && echo 'export PATH="$HOME/bin:$PATH"' >> "$HOME/.zshrc"
        [ -f "$HOME/.config/fish/config.fish" ] && echo 'set -gx PATH $HOME/bin $PATH' >> "$HOME/.config/fish/config.fish"
        echo -e "${YELLOW}[!] Added $HOME/bin to PATH. You may need to restart terminal.${NC}"
    fi

    mkdir -p "$BIN_DIR"
    mkdir -p "$CONFIG_DIR"
    mkdir -p "$SCRIPTS_DIR"
    STATIC_DIR="$CONFIG_DIR/static"
    mkdir -p "$STATIC_DIR"

    # Copy enhanced dashboard
    echo "ðŸ“Š Installing enhanced dashboard..."
    DASHBOARD_SRC="$(dirname "$0")/assets/static/dashboard.html"
    if [ -f "$DASHBOARD_SRC" ]; then
        cp "$DASHBOARD_SRC" "$STATIC_DIR/dashboard.html"
        echo -e "${GREEN}[OK] Dashboard installed from local assets${NC}"
    else
        # Fallback: try to download from GitHub
        if curl -fsSL "https://raw.githubusercontent.com/khmuhtadin/cliproxy-installer/main/assets/static/dashboard.html" -o "$STATIC_DIR/dashboard.html" 2>/dev/null; then
            echo -e "${GREEN}[OK] Dashboard downloaded from GitHub${NC}"
        else
            echo -e "${YELLOW}[!] Could not install dashboard${NC}"
        fi
    fi

    # Install cp-db command
    echo "ðŸ”® Installing cp-db shortcut..."
    CPDB_SRC="$(dirname "$0")/assets/scripts/cp-db.sh"
    if [ -f "$CPDB_SRC" ]; then
        sudo cp "$CPDB_SRC" /usr/local/bin/cp-db
        sudo chmod +x /usr/local/bin/cp-db
        echo -e "${GREEN}[OK] cp-db installed from local assets${NC}"
    else
        # Fallback: try to download from GitHub
        if curl -fsSL "https://raw.githubusercontent.com/khmuhtadin/cliproxy-installer/main/assets/scripts/cp-db.sh" -o "/tmp/cp-db" 2>/dev/null; then
            sudo mv /tmp/cp-db /usr/local/bin/cp-db
            sudo chmod +x /usr/local/bin/cp-db
            echo -e "${GREEN}[OK] cp-db downloaded from GitHub${NC}"
        else
            echo -e "${YELLOW}[!] Could not install cp-db command${NC}"
        fi
    fi


    # Clone & Build
    TEMP_DIR=$(mktemp -d)
    echo "Cloning repository..."
    if ! git clone --depth 1 https://github.com/router-for-me/CLIProxyAPIPlus.git "$TEMP_DIR"; then
        echo -e "${RED}[Error] Failed to clone repository${NC}"
        rm -rf "$TEMP_DIR"
        exit 1
    fi

    echo "Building binary..."
    cd "$TEMP_DIR"
    if ! go build -o cliproxyapi-plus ./cmd/server; then
        echo -e "${RED}[Error] Failed to build binary${NC}"
        cd -
        rm -rf "$TEMP_DIR"
        exit 1
    fi
    mv -f cliproxyapi-plus "$BIN_DIR/cliproxyapi-plus"
    cd -
    rm -rf "$TEMP_DIR"

    echo -e "${GREEN}[OK] Binary built and installed successfully.${NC}"

    # Config
    # Only create if it doesn't exist, to preserve user settings on update
    if [ ! -f "$CONFIG_DIR/config.yaml" ]; then
        cat > "$CONFIG_DIR/config.yaml" <<EOF
port: 8317
auth-dir: "$CONFIG_DIR"
api-keys:
  - "sk-dummy"
quota-exceeded:
  switch-project: true
  switch-preview-model: true
EOF
    fi

    # Helper Scripts
    cat > "$SCRIPTS_DIR/start.sh" <<'EOF'
#!/bin/bash
echo "Starting CLIProxy on http://localhost:8317"
"$HOME/bin/cliproxyapi-plus" --config "$HOME/.cli-proxy-api/config.yaml"
EOF
    chmod +x "$SCRIPTS_DIR/start.sh"

    cat > "$SCRIPTS_DIR/login.sh" <<'EOF'
#!/bin/bash
BINARY="$HOME/bin/cliproxyapi-plus"
CONFIG="$HOME/.cli-proxy-api/config.yaml"
clear
echo "1. Antigravity (Claude/Gemini)"
echo "2. GitHub Copilot"
echo "3. Gemini CLI"
echo "4. Codex"
echo "5. Claude"
echo "6. Qwen"
echo "7. iFlow"
echo "8. Kiro"
read -p "Select provider (1-8): " c
case $c in
  1) "$BINARY" --config "$CONFIG" -antigravity-login ;;
  2) "$BINARY" --config "$CONFIG" -github-copilot-login ;;
  3) "$BINARY" --config "$CONFIG" -login ;;
  4) "$BINARY" --config "$CONFIG" -codex-login ;;
  5) "$BINARY" --config "$CONFIG" -claude-login ;;
  6) "$BINARY" --config "$CONFIG" -qwen-login ;;
  7) "$BINARY" --config "$CONFIG" -iflow-login ;;
  8) "$BINARY" --config "$CONFIG" -kiro-login ;;
  *) echo "Invalid" ;;
esac
EOF
    chmod +x "$SCRIPTS_DIR/login.sh"

    # Create logout script
    cat > "$SCRIPTS_DIR/logout.sh" <<'EOF'
#!/bin/bash
CONFIG_DIR="$HOME/.cli-proxy-api"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

clear
echo -e "${CYAN}========================================${NC}"
echo -e "${CYAN}   CLIProxy Logout Manager${NC}"
echo -e "${CYAN}========================================${NC}"
echo ""
echo "Select provider to logout:"
echo ""
echo "1. Antigravity"
echo "2. GitHub Copilot"
echo "3. Gemini CLI"
echo "4. Codex"
echo "5. Claude"
echo "6. Qwen"
echo "7. iFlow"
echo "8. Kiro"
echo "9. Logout ALL providers"
echo "0. Cancel"
echo ""
read -p "Select option (0-9): " choice

count=0
case $choice in
    1)
        count=$(find "$CONFIG_DIR" -maxdepth 1 -name "antigravity*.json" -type f -delete -print | wc -l)
        if [ $count -gt 0 ]; then
            echo -e "${GREEN}[OK] Removed $count Antigravity session(s)${NC}"
        else
            echo -e "${YELLOW}[!] No Antigravity sessions found${NC}"
        fi
        ;;
    2)
        count=$(find "$CONFIG_DIR" -maxdepth 1 -name "github*copilot*.json" -o -name "copilot*.json" -type f -delete -print | wc -l)
        if [ $count -gt 0 ]; then
            echo -e "${GREEN}[OK] Removed $count GitHub Copilot session(s)${NC}"
        else
            echo -e "${YELLOW}[!] No GitHub Copilot sessions found${NC}"
        fi
        ;;
    3)
        count=$(find "$CONFIG_DIR" -maxdepth 1 -name "gemini*.json" -type f -delete -print | wc -l)
        if [ $count -gt 0 ]; then
            echo -e "${GREEN}[OK] Removed $count Gemini CLI session(s)${NC}"
        else
            echo -e "${YELLOW}[!] No Gemini CLI sessions found${NC}"
        fi
        ;;
    4)
        count=$(find "$CONFIG_DIR" -maxdepth 1 -name "codex*.json" -type f -delete -print | wc -l)
        if [ $count -gt 0 ]; then
            echo -e "${GREEN}[OK] Removed $count Codex session(s)${NC}"
        else
            echo -e "${YELLOW}[!] No Codex sessions found${NC}"
        fi
        ;;
    5)
        count=$(find "$CONFIG_DIR" -maxdepth 1 -name "claude*.json" -type f -delete -print | wc -l)
        if [ $count -gt 0 ]; then
            echo -e "${GREEN}[OK] Removed $count Claude session(s)${NC}"
        else
            echo -e "${YELLOW}[!] No Claude sessions found${NC}"
        fi
        ;;
    6)
        count=$(find "$CONFIG_DIR" -maxdepth 1 -name "qwen*.json" -type f -delete -print | wc -l)
        if [ $count -gt 0 ]; then
            echo -e "${GREEN}[OK] Removed $count Qwen session(s)${NC}"
        else
            echo -e "${YELLOW}[!] No Qwen sessions found${NC}"
        fi
        ;;
    7)
        count=$(find "$CONFIG_DIR" -maxdepth 1 -name "iflow*.json" -type f -delete -print | wc -l)
        if [ $count -gt 0 ]; then
            echo -e "${GREEN}[OK] Removed $count iFlow session(s)${NC}"
        else
            echo -e "${YELLOW}[!] No iFlow sessions found${NC}"
        fi
        ;;
    8)
        count=$(find "$CONFIG_DIR" -maxdepth 1 -name "kiro*.json" -type f -delete -print | wc -l)
        if [ $count -gt 0 ]; then
            echo -e "${GREEN}[OK] Removed $count Kiro session(s)${NC}"
        else
            echo -e "${YELLOW}[!] No Kiro sessions found${NC}"
        fi
        ;;
    9)
        # Remove all JSON files except config.yaml
        count=$(find "$CONFIG_DIR" -maxdepth 1 -name "*.json" -type f -delete -print | wc -l)
        if [ $count -gt 0 ]; then
            echo -e "${GREEN}[OK] Removed $count session file(s)${NC}"
        else
            echo -e "${YELLOW}[!] No session files found${NC}"
        fi
        ;;
    0)
        echo "Cancelled."
        exit 0
        ;;
    *)
        echo -e "${RED}Invalid choice${NC}"
        exit 1
        ;;
esac

echo ""
echo -e "${YELLOW}Note: You'll need to run 'cp-login' again to use the removed provider(s)${NC}"
EOF
    chmod +x "$SCRIPTS_DIR/logout.sh"

    # Create uninstall script
    cat > "$SCRIPTS_DIR/uninstall.sh" <<'EOF'
#!/bin/bash

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

clear
echo -e "${RED}========================================${NC}"
echo -e "${RED}   CLIProxy Uninstaller${NC}"
echo -e "${RED}========================================${NC}"
echo ""
echo -e "${YELLOW}This will remove:${NC}"
echo "  - CLIProxy binary and config files"
echo "  - All authentication sessions"
echo "  - Shell shortcuts (cp-login, cp-start, etc.)"
echo "  - Dashboard files"
echo "  - cp-db command"
echo ""
echo -e "${YELLOW}This will NOT remove:${NC}"
echo "  - Git (kept for other projects)"
echo "  - Go compiler (kept for other projects)"
echo ""
read -p "Are you sure you want to uninstall? (yes/no): " confirm

if [ "$confirm" != "yes" ]; then
    echo "Uninstall cancelled."
    exit 0
fi

echo ""
echo -e "${YELLOW}Uninstalling CLIProxy...${NC}"

# Remove binary
rm -f "$HOME/bin/cliproxyapi-plus"
echo -e "${GREEN}[OK] Binary removed${NC}"

# Remove config directory
rm -rf "$HOME/.cli-proxy-api"
echo -e "${GREEN}[OK] Config directory removed${NC}"

# Remove cp-db command
sudo rm -f /usr/local/bin/cp-db
echo -e "${GREEN}[OK] cp-db command removed${NC}"

# Remove Droid config models (optional - user might want to keep)
read -p "Remove CLIProxy models from Droid config? (yes/no): " remove_droid
if [ "$remove_droid" == "yes" ]; then
    DROID_FILE="$HOME/.factory/config.json"
    if [ -f "$DROID_FILE" ]; then
        # Backup first
        cp "$DROID_FILE" "$DROID_FILE.backup.$(date +%s)"
        
        # Remove CLIProxy entries (models with localhost:8317)
        if command -v jq &> /dev/null; then
            jq 'if .custom_models then .custom_models |= map(select(.base_url != "http://localhost:8317/v1")) else . end' "$DROID_FILE" > "$DROID_FILE.tmp" && mv "$DROID_FILE.tmp" "$DROID_FILE"
            echo -e "${GREEN}[OK] Droid config cleaned (backup created)${NC}"
        else
            echo -e "${YELLOW}[!] jq not found, skipping Droid config cleanup${NC}"
        fi
    fi
fi

# Remove shell shortcuts
for config_file in "$HOME/.bashrc" "$HOME/.zshrc" "$HOME/.config/fish/config.fish"; do
    if [ -f "$config_file" ]; then
        # Backup first
        cp "$config_file" "${config_file}.backup.$(date +%s)"
        
        # Remove CLIProxy shortcuts
        sed -i '/# CLIProxy Shortcuts/d' "$config_file" 2>/dev/null || true
        sed -i '/alias cp-login/d' "$config_file" 2>/dev/null || true
        sed -i '/alias cp-start/d' "$config_file" 2>/dev/null || true
        sed -i '/alias cp-logout/d' "$config_file" 2>/dev/null || true
        sed -i '/alias cp-uninstall/d' "$config_file" 2>/dev/null || true
        sed -i '/alias cp-update/d' "$config_file" 2>/dev/null || true
        
        echo -e "${GREEN}[OK] Shortcuts removed from $(basename $config_file)${NC}"
    fi
done

echo ""
echo -e "${GREEN}========================================${NC}"
echo -e "${GREEN}  Uninstall Complete!${NC}"
echo -e "${GREEN}========================================${NC}"
echo ""
echo -e "${YELLOW}Git and Go have been kept installed for other projects.${NC}"
echo -e "${YELLOW}Restart your terminal or run 'source ~/.bashrc' to complete removal.${NC}"
echo ""
echo "Thank you for using CLIProxy! ðŸ‘‹"
EOF
    chmod +x "$SCRIPTS_DIR/uninstall.sh"

    # Droid Config Injection
    DROID_FILE="$HOME/.factory/config.json"
    mkdir -p "$(dirname "$DROID_FILE")"

    # Define target models
    cat > "/tmp/cliproxy_new_models.json" <<EOF
{
    "custom_models": [
        { "model_display_name": "GPT-OSS 120B Medium [Antigravity]", "model": "gpt-oss-120b-medium", "base_url": "http://localhost:8317/v1", "api_key": "sk-dummy", "provider": "openai" },
        { "model_display_name": "GPT-OSS 120B Large [Antigravity]", "model": "gpt-oss-120b-large", "base_url": "http://localhost:8317/v1", "api_key": "sk-dummy", "provider": "openai" },
        { "model_display_name": "Claude Opus 4.5 Thinking [Antigravity]", "model": "gemini-claude-opus-4-5-thinking", "base_url": "http://localhost:8317/v1", "api_key": "sk-dummy", "provider": "openai" },
        { "model_display_name": "Claude Sonnet 4.5 Thinking [Antigravity]", "model": "gemini-claude-sonnet-4-5-thinking", "base_url": "http://localhost:8317/v1", "api_key": "sk-dummy", "provider": "openai" },
        { "model_display_name": "Claude Sonnet 4.5 [Antigravity]", "model": "gemini-claude-sonnet-4-5", "base_url": "http://localhost:8317/v1", "api_key": "sk-dummy", "provider": "openai" },
        { "model_display_name": "Gemini 3 Pro [Antigravity]", "model": "gemini-3-pro-preview", "base_url": "http://localhost:8317/v1", "api_key": "sk-dummy", "provider": "openai" },
        { "model_display_name": "Claude Opus 4.5 [Copilot]", "model": "claude-opus-4.5", "base_url": "http://localhost:8317/v1", "api_key": "sk-dummy", "provider": "openai" },
        { "model_display_name": "GPT-5 Mini [Copilot]", "model": "gpt-5-mini", "base_url": "http://localhost:8317/v1", "api_key": "sk-dummy", "provider": "openai" },
        { "model_display_name": "GPT-5.1 Codex Max [Codex]", "model": "gpt-5.1-codex-max", "base_url": "http://localhost:8317/v1", "api_key": "sk-dummy", "provider": "openai" },
        { "model_display_name": "Gemini 3 Ultra [Antigravity]", "model": "gemini-3-ultra-preview", "base_url": "http://localhost:8317/v1", "api_key": "sk-dummy", "provider": "openai" },
        { "model_display_name": "Llama 4 405B [Meta]", "model": "llama-4-405b-instruct", "base_url": "http://localhost:8317/v1", "api_key": "sk-dummy", "provider": "openai" },
        { "model_display_name": "Nano Banana [Local]", "model": "nano-banana-v1", "base_url": "http://localhost:8317/v1", "api_key": "sk-dummy", "provider": "openai" },
        { "model_display_name": "Gemini 2.5 Pro [Gemini]", "model": "gemini-2.5-pro", "base_url": "http://localhost:8317/v1", "api_key": "sk-dummy", "provider": "openai" },
        { "model_display_name": "Qwen3 Coder Plus [Qwen]", "model": "qwen3-coder-plus", "base_url": "http://localhost:8317/v1", "api_key": "sk-dummy", "provider": "openai" },
        { "model_display_name": "GLM 4.6 [iFlow]", "model": "glm-4.6", "base_url": "http://localhost:8317/v1", "api_key": "sk-dummy", "provider": "openai" },
        { "model_display_name": "Claude Opus 4.5 [Kiro]", "model": "kiro-claude-opus-4.5", "base_url": "http://localhost:8317/v1", "api_key": "sk-dummy", "provider": "openai" },
        { "model_display_name": "Claude Sonnet 4.5 [Kiro]", "model": "kiro-claude-sonnet-4.5", "base_url": "http://localhost:8317/v1", "api_key": "sk-dummy", "provider": "openai" },
        { "model_display_name": "Claude Sonnet 4 [Kiro]", "model": "kiro-claude-sonnet-4", "base_url": "http://localhost:8317/v1", "api_key": "sk-dummy", "provider": "openai" },
        { "model_display_name": "Claude Haiku 4.5 [Kiro]", "model": "kiro-claude-haiku-4.5", "base_url": "http://localhost:8317/v1", "api_key": "sk-dummy", "provider": "openai" }
    ]
}
EOF

    if [ ! -f "$DROID_FILE" ]; then
        cp "/tmp/cliproxy_new_models.json" "$DROID_FILE"
        echo -e "${GREEN}[OK] Droid config created.${NC}"
    else
        echo -e "${YELLOW}[!] config.json exists, checking for missing models...${NC}"

        # Download and use shared merge utility
        MERGE_UTIL="/tmp/merge_config_$$.go"
        if curl -fsSL "https://raw.githubusercontent.com/khmuhtadin/cliproxy-installer/main/merge-config.go" -o "$MERGE_UTIL"; then
            go run "$MERGE_UTIL" "$DROID_FILE" "/tmp/cliproxy_new_models.json"
            rm -f "$MERGE_UTIL"
        else
            echo -e "${RED}[Error] Failed to download config merger. Skipping model merge.${NC}"
        fi
    fi
    rm -f "/tmp/cliproxy_new_models.json"


    # CALL SHORTCUT SETUP
    setup_shortcuts

    echo -e "${GREEN}========================================${NC}"
    echo -e "${GREEN}  INSTALLATION SUCCESS!${NC}"
    echo -e "${GREEN}========================================${NC}"
    echo "Restart your terminal or run 'source ~/.bashrc' (or zshrc) to use shortcuts:"
    echo -e "  1. Login:     ${CYAN}cp-login${NC}"
    echo -e "  2. Start:     ${CYAN}cp-start${NC}"
    echo -e "  3. Logout:    ${CYAN}cp-logout${NC}"
    echo -e "  4. Uninstall: ${CYAN}cp-uninstall${NC}"
    echo -e "  5. Update:    ${CYAN}cp-update${NC}"
}

# --- Main Execution ---

if [[ "$1" == "-update" ]]; then
    echo -e "${CYAN}========================================${NC}"
    echo -e "${CYAN}   Updating CLIProxy...${NC}"
    echo -e "${CYAN}========================================${NC}"
    install_dependencies
    install_cliproxy
    echo -e "${GREEN}Update complete!${NC}"
    exit 0
fi

# --- Main Menu ---

clear
echo -e "${CYAN}========================================${NC}"
echo -e "${CYAN}   CLIProxy Linux Installer Manager${NC}"
echo -e "${CYAN}========================================${NC}"
echo ""
echo "1. Install Dependencies (Git & Go)"
echo "2. Install / Update CLIProxy Core"
echo "3. FULL INSTALL (Recommended for first run)"
echo "4. Exit"
echo ""
read -p "Please select your choice (1-4): " choice

case $choice in
    1) install_dependencies ;;
    2) install_cliproxy ;;
    3)
        install_dependencies
        install_cliproxy
        ;;
    4) exit 0 ;;
    *) echo "Invalid choice." ;;
esac
