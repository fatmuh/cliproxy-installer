#!/usr/bin/env bash
# ==============================================================================
# CLIProxy Linux Installer (SAFE FOR CURL | BASH)
# ==============================================================================

RED='\033[0;31m'
GREEN='\033[0;32m'
CYAN='\033[0;36m'
NC='\033[0m'

log(){ echo -e "${CYAN}[*]${NC} $*"; }
ok(){ echo -e "${GREEN}[OK]${NC} $*"; }

BIN="$HOME/bin"
CFG="$HOME/.cli-proxy-api"
SCR="$CFG/scripts"
PORT=8317

# ------------------------------------------------------------------------------
log "Preparing directories..."
mkdir -p "$BIN" "$SCR"

# ------------------------------------------------------------------------------
log "Ensuring Go..."
if ! command -v go >/dev/null 2>&1; then
  . /etc/os-release
  case "$ID" in
    debian|ubuntu|kali|pop)
      sudo apt update
      sudo apt install -y golang
      ;;
    arch|manjaro)
      sudo pacman -S --noconfirm go
      ;;
    fedora)
      sudo dnf install -y golang
      ;;
    *)
      echo "Install Go manually"; exit 1;;
  esac
fi

# ------------------------------------------------------------------------------
log "Installing CLIProxy..."
TMP=$(mktemp -d)
git clone --depth 1 https://github.com/router-for-me/CLIProxyAPIPlus.git "$TMP"
cd "$TMP" || exit 1
go build -o cliproxyapi-plus ./cmd/server
mv cliproxyapi-plus "$BIN/"
cd ~
rm -rf "$TMP"

# ------------------------------------------------------------------------------
log "Writing config..."
mkdir -p "$CFG"
cat > "$CFG/config.yaml" <<EOF
port: $PORT
auth-dir: "$CFG"
api-keys:
  - "sk-dummy"
EOF

# ------------------------------------------------------------------------------
log "Writing scripts..."

cat > "$SCR/start.sh" <<EOF
#!/usr/bin/env bash
exec "$BIN/cliproxyapi-plus" --config "$CFG/config.yaml"
EOF

cat > "$SCR/login.sh" <<EOF
#!/usr/bin/env bash
"$BIN/cliproxyapi-plus" --config "$CFG/config.yaml" -antigravity-login
EOF

cat > "$SCR/logout.sh" <<EOF
#!/usr/bin/env bash
rm -rf "$CFG"/{antigravity,copilot,claude,gemini,qwen,iflow,kiro,session.json}
echo "Logged out"
EOF

cat > "$SCR/uninstall.sh" <<'EOF'
#!/usr/bin/env bash
read -p "Type YES to uninstall: " C
[[ "$C" == "YES" ]] || exit 1

pkill -x cliproxyapi-plus 2>/dev/null || true
rm -rf "$HOME/.cli-proxy-api" "$HOME/bin/cliproxyapi-plus"

sed -i '/cp-/d' ~/.bashrc ~/.zshrc 2>/dev/null || true

echo "CLIProxy removed"
EOF

chmod +x "$SCR/"*.sh

# ------------------------------------------------------------------------------
log "Registering aliases..."
cat >> "$HOME/.bashrc" <<EOF

# CLIProxy
alias cp-start="$SCR/start.sh"
alias cp-login="$SCR/login.sh"
alias cp-logout="$SCR/logout.sh"
alias cp-uninstall="$SCR/uninstall.sh"
EOF

# ------------------------------------------------------------------------------
ok "INSTALL SUCCESS"
echo "Restart terminal or run: source ~/.bashrc"
