#!/usr/bin/env bash
# ==============================================================================
# CLIProxy Linux Installer (CLEAN + FULL)
# Commands:
#   cp-login
#   cp-logout
#   cp-start
#   cp-update
#   cp-uninstall
#
# Git is NOT touched
# Go will be removed on uninstall
# ==============================================================================

set -Eeuo pipefail

# ---------------- COLORS ----------------
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

log() { echo -e "${CYAN}[*]${NC} $*"; }
ok()  { echo -e "${GREEN}[OK]${NC} $*"; }
warn(){ echo -e "${YELLOW}[WARN]${NC} $*"; }
die() { echo -e "${RED}[ERR]${NC} $*"; exit 1; }

# ---------------- PATHS ----------------
BIN_DIR="$HOME/bin"
CFG_DIR="$HOME/.cli-proxy-api"
SCR_DIR="$CFG_DIR/scripts"

# ---------------- CLEAN OLD CLIProxy ----------------
clean_old() {
  log "Cleaning old CLIProxy installs..."

  pkill -f cliproxyapi 2>/dev/null || true

  rm -f \
    "$BIN_DIR/cliproxyapi" \
    "$BIN_DIR/cliproxyapi-plus" \
    "/usr/local/bin/cliproxyapi" \
    "/usr/local/bin/cliproxyapi-plus"

  rm -rf \
    "$HOME/.cliproxyapi" \
    "$HOME/.cli-proxy-api" \
    "$HOME/.config/cli-proxy-api"

  for rc in "$HOME/.bashrc" "$HOME/.zshrc"; do
    [[ -f "$rc" ]] || continue
    sed -i '/cp-login/d;/cp-logout/d;/cp-start/d;/cp-update/d;/cp-uninstall/d;/CLIProxy/d' "$rc"
  done

  ok "Old CLIProxy cleaned"
}

# ---------------- INSTALL GO ----------------
install_go() {
  if command -v go >/dev/null 2>&1; then
    ok "Go already installed"
    return
  fi

  log "Installing Go..."
  . /etc/os-release

  case "$ID" in
    debian|ubuntu|kali|pop)
      sudo apt update
      sudo apt install -y golang
      ;;
    arch|manjaro)
      sudo pacman -S --noconfirm go
      ;;
    fedora)
      sudo dnf install -y golang
      ;;
    *)
      die "Unsupported distro, install Go manually"
      ;;
  esac
}

# ---------------- BUILD CLIProxy ----------------
install_cliproxy() {
  mkdir -p "$BIN_DIR" "$SCR_DIR"

  if [[ ":$PATH:" != *":$BIN_DIR:"* ]]; then
    echo 'export PATH="$HOME/bin:$PATH"' >> "$HOME/.bashrc"
    [[ -f "$HOME/.zshrc" ]] && echo 'export PATH="$HOME/bin:$PATH"' >> "$HOME/.zshrc"
  fi

  log "Building CLIProxy..."
  TMP="$(mktemp -d)"
  git clone --depth 1 https://github.com/router-for-me/CLIProxyAPIPlus.git "$TMP"
  cd "$TMP"
  go build -o cliproxyapi-plus ./cmd/server
  mv cliproxyapi-plus "$BIN_DIR/"
  cd - >/dev/null
  rm -rf "$TMP"

  ok "CLIProxy installed"
}

# ---------------- CONFIG ----------------
write_config() {
  mkdir -p "$CFG_DIR"

  cat > "$CFG_DIR/config.yaml" <<EOF
port: 8317
auth-dir: "$CFG_DIR"
api-keys:
  - "sk-dummy"
EOF
}

# ---------------- SCRIPTS ----------------
write_scripts() {

# ---- START ----
cat > "$SCR_DIR/start.sh" <<EOF
#!/usr/bin/env bash
exec "$BIN_DIR/cliproxyapi-plus" --config "$CFG_DIR/config.yaml"
EOF

# ---- LOGIN ----
cat > "$SCR_DIR/login.sh" <<EOF
#!/usr/bin/env bash
"$BIN_DIR/cliproxyapi-plus" --config "$CFG_DIR/config.yaml" -antigravity-login
EOF

# ---- LOGOUT ----
cat > "$SCR_DIR/logout.sh" <<EOF
#!/usr/bin/env bash
echo "[*] Logging out all providers..."
rm -rf \
  "$CFG_DIR/antigravity" \
  "$CFG_DIR/copilot" \
  "$CFG_DIR/gemini" \
  "$CFG_DIR/claude" \
  "$CFG_DIR/qwen" \
  "$CFG_DIR/iflow" \
  "$CFG_DIR/kiro" \
  "$CFG_DIR/session.json"
echo "[OK] Logged out"
EOF

# ---- UNINSTALL ----
cat > "$SCR_DIR/uninstall.sh" <<'EOF'
#!/usr/bin/env bash
set -Eeuo pipefail

echo "CLIProxy Uninstall"
read -p "Type YES to continue: " C
[[ "$C" == "YES" ]] || exit 1

pkill -f cliproxyapi 2>/dev/null || true

rm -f "$HOME/bin/cliproxyapi-plus"
sudo rm -f /usr/local/bin/cliproxyapi-plus

rm -rf "$HOME/.cli-proxy-api" "$HOME/.cliproxyapi"

rm -f "$HOME/bin/cp-"*
sudo rm -f /usr/local/bin/cp-* 2>/dev/null || true

sed -i '/cp-login/d;/cp-logout/d;/cp-start/d;/cp-update/d;/cp-uninstall/d' \
  ~/.bashrc ~/.zshrc 2>/dev/null || true

if command -v go >/dev/null 2>&1; then
  . /etc/os-release
  case "$ID" in
    debian|ubuntu|kali|pop)
      sudo apt purge -y golang golang-go
      sudo apt autoremove -y
      ;;
    arch|manjaro)
      sudo pacman -Rns --noconfirm go
      ;;
    fedora)
      sudo dnf remove -y golang
      ;;
  esac
fi

rm -rf "$HOME/go"
sudo rm -rf /usr/local/go 2>/dev/null || true

echo "[OK] CLIProxy uninstalled"
EOF

  chmod +x "$SCR_DIR/"*.sh
}

# ---------------- ALIASES ----------------
write_aliases() {
cat >> "$HOME/.bashrc" <<EOF

# CLIProxy
alias cp-login="$SCR_DIR/login.sh"
alias cp-logout="$SCR_DIR/logout.sh"
alias cp-start="$SCR_DIR/start.sh"
alias cp-uninstall="$SCR_DIR/uninstall.sh"
alias cp-update="curl -sL https://raw.githubusercontent.com/khmuhtadin/cliproxy-installer/main/install-linux | bash"
EOF
}

# ---------------- MAIN ----------------
if [[ "${1:-}" == "-update" ]]; then
  clean_old
fi

clean_old
install_go
install_cliproxy
write_config
write_scripts
write_aliases

echo
ok "CLIProxy installation complete"
echo "Restart terminal or run: source ~/.bashrc"
